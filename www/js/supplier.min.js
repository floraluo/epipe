angular.module("starter.controller",[]).controller("SupplierCtrl",["$rootScope","$scope","$state","$ionicHistory","$ionicTabsDelegate",function($rootScope,$scope,$state,$ionicHistory,$ionicTabsDelegate){$rootScope.myGoBack=function(){var backViewName=$ionicHistory.viewHistory().backView.stateName;"supplier.quotation"==backViewName&&($ionicHistory.goBack(-2),window.location.reload()),"supplier.logisticsTracking"!=backViewName&&$ionicTabsDelegate.showBar(!0),$ionicHistory.goBack()},$rootScope.main={dragContent:!0,hideTabs:!1},$scope.logout=function(){window.localStorage.token=null,$ionicHistory.clearHistory(),$ionicHistory.clearCache()}}]).controller("homeCtrl",["$scope","$state","$ionicHistory","$rootScope","$ionicBackdrop","$ionicLoading",function($scope,$state,$ionicHistory,$rootScope,$ionicBackdrop,$ionicLoading){$rootScope.main.dragContent=!1,$ionicHistory.nextViewOptions({disableBack:!0}),$ionicBackdrop.retain(),$ionicLoading.show({template:"<ion-spinner icon='ios' class='spinner spinner-ios '></ion-spinner>",noBackdrop:!0});var hostListener=$rootScope.$watch("appReady.getHost",function(){$rootScope.appReady.getHost&&($ionicBackdrop.release(),$ionicLoading.hide(),hostListener())});$scope.homeButton=function(){null==window.localStorage.token||"null"==window.localStorage.token?$state.go("supplier.login"):$state.go("supplier.release")}}]).controller("loginCtrl",["$scope","$rootScope","$ionicPopup","httpService","$state",function($scope,$rootScope,$ionicPopup,httpService,$state){$rootScope.main.dragContent=!1,$scope.user={name:"",password:""},$scope.supplier={show_error:!1},$scope.supplierLogin=function(myform){$scope.supplier.show_error=!0,myform.$valid&&httpService.post("/user/login",{phone:$scope.user.name,password:$scope.user.password,userType:"供应商"}).success(function(data){data.status?(window.localStorage.token=data.token,window.localStorage.come=!0,$state.go("supplier.release")):$ionicPopup.alert({template:"用户名或密码错误"})})}}]).controller("registerCtrl",["$scope","$interval","$rootScope","$state","$cordovaCamera","$ionicActionSheet","httpService","$ionicPopup",function($scope,$interval,$rootScope,$state,$cordovaCamera,$ionicActionSheet,httpService,$ionicPopup){$scope.userRegisInfo={userType:"供应商",phone:"",code:"",password:"",userProfile:{company:""}},$scope.show_error=!1,$scope.code_is_error=!1,$scope.captcha={text:"获取验证码",disabled:!1},$scope.interval=40,$scope.supplierCheckPhone=function(phone){httpService.get("/user/checkPhone/"+phone).success(function(data){data.status?$ionicPopup.alert({template:"电话号码已存在"}):console.log("success")})},$scope.fetchCaptcha=function(){httpService.post("/user/sendPhoneToken",{phone:$scope.userRegisInfo.phone}).success(function(data){console.log(data),$scope.code=201601,$scope.captcha={disabled:!0,text:$scope.interval+" 秒之后重新获取"},$scope.timer()})},$scope.verifyCode=function(code){console.log("userRegisInfo.code: "+$scope.userRegisInfo.code+"     $scope.code: "+$scope.code),$scope.userRegisInfo.code!=$scope.code?$scope.code_is_error=!0:$scope.code_is_error=!1},$scope.timer=function(){function updateTime(){time--,$scope.captcha.text=time+" 秒之后重新获取",0==time&&($scope.captcha={disabled:!1,text:"获取验证码"},$interval.cancel(stopTime))}var stopTime,time=$scope.interval;stopTime=$interval(updateTime,1e3)},$scope.supplierRegiste=function(myform){$scope.show_error=!0,myform.$dirty&&myform.$valid&&httpService.post("/user/regist",$scope.userRegisInfo).success(function(data){data.status?$state.go("supplier.login"):$ionicPopup.alert({template:data.errMsg})})}}]).controller("personalCtrl",["$scope","$ionicPopup","$rootScope","httpService","$state",function($scope,$ionicPopup,$rootScope,httpService,$state){$rootScope.$watch("appReady.status",function(){$rootScope.appReady.status&&($scope.ready=!0)}),$scope.supplier={userType:"供应商",userProfile:{company:""}},$scope.$on("$ionicView.beforeEnter",function(){httpService.get("/user/getProfile").success(function(data){var profile=data.data;$scope.supplier={company:profile.company,phone:profile.phone}})}),$scope.show_error=!1,$scope.supplierModPerInfo=function(myform){$scope.show_error=!0,myform.$valid&&myform.$dirty&&httpService.post("/user/changeProfile",$scope.supplier).success(function(data){if(data.status){var promise=$ionicPopup.alert({template:"修改成功！",okText:"确认",okType:"button-my-balanced"});promise.then(function(data){data&&$state.go("supplier.personal")})}})}}]).controller("ModifyPasswordCtrl",["$scope","$ionicPopup","httpService","$state",function($scope,$ionicPopup,httpService,$state){$scope.supplier={userType:"供应商",oldPassword:"",newPassword:""},$scope.show_error=!1,$scope.supplierModPassword=function(myform){$scope.show_error=!0,myform.$valid&&myform.$dirty&&httpService.post("/user/changePassword",{oldPassword:$scope.supplier.oldPassword,password:$scope.supplier.newPassword}).success(function(data){data.status?$ionicPopup.alert({template:"密码修改成功！",okText:"确认",okType:"button-my-balanced"}).then(function(data){data&&$state.go("supplier.personal")}):$ionicPopup.alert({template:data.errMsg,okText:"确认",okType:"button-my-balanced"})})}}]).controller("releaseCtrl",["$scope","$state","$ionicPopup","httpService","$rootScope","$timeout",function($scope,$state,$ionicPopup,httpService,$rootScope,$timeout){$rootScope.main.dragContent=!0,$scope.keywords=["","",""],httpService.get("/keywords/getKeywords").success(function(data){if(data.status){var keywordsArray=data.data.keywords,len=keywordsArray.length;if($scope.keywords=keywordsArray,3>len)for(var i=len;3>i;i++)$scope.keywords.push("")}}),$scope.addKeywords=function(){$timeout(function(){$scope.keywords.push("")},10)},$scope.cleanArray=function(array){for(var newArray=[],i=0;i<array.length;i++)array[i]&&newArray.push(array[i]);return newArray},$scope.releaseKeywords=function(){var cleanArray=$scope.cleanArray($scope.keywords);httpService.post("/keywords/setKeywords",{keywords:cleanArray}).success(function(data){if(data.status){cleanArray.toString();$state.go("supplier.orderList")}else $ionicPopup.alert({title:"关键字发布结果",template:data.errMsg,okText:"确定",okType:"button-my-balanced"})})}}]).controller("orderListCtrl",["$scope","httpService","$state","$stateParams","$ionicScrollDelegate","$ionicPopup","$http",function($scope,httpService,$state,$stateParams,$ionicScrollDelegate,$ionicPopup,$http){$scope.order={canBeLoaded:!1,mostData:!1,content:[],showNoOrderText:!1,count:5,oldCount:0,oldMaxCount:0},httpService.get("/order/getMyOldOrders/"+$scope.order.count+"/"+$scope.order.oldCount+"/"+$scope.order.oldMaxCount).success(function(data){if(data.status){var orderData=data.data,orderArray=orderData.orders,len=orderArray.length;orderData.maxCount>0?($scope.order.content=orderArray,$scope.order.oldCount=len,$scope.order.oldMaxCount=orderData.maxCount,$scope.order.canBeLoaded=!0,$scope.order.showNoOrderText=!1,len==orderData.maxCount&&($scope.order.mostData=!0)):($scope.order.content=orderArray,$scope.order.oldCount=len,$scope.order.oldMaxCount=orderData.maxCount,$ionicPopup.confirm({title:"采购单筛选结果",template:"暂无匹配的订单！",okText:"返回",cancelText:"留在此页",okType:"button-my-balanced",cancelType:"button-stable"}).then(function(data){data?$state.go("supplier.release"):$scope.order.showNoOrderText=!0}))}}),$scope.loadNewOrderList=function(){httpService.get("/order/getMyNewOrders/"+$scope.order.oldCount+"/"+$scope.order.oldMaxCount).success(function(data){var orderData=data.data,orderArray=orderData.orders,len=orderArray.length;data.status&&($scope.order.content=orderArray,$scope.order.oldCount=len,$scope.order.oldMaxCount=orderData.maxCount)})["finally"](function(){$scope.$broadcast("scroll.refreshComplete")})},$scope.loadMoreOrder=function(){$scope.order.mostData?($scope.order.canBeLoaded=!1,$ionicPopup.alert({template:"没有更多数据了！",okText:"确认",okType:"button-my-balanced"})):httpService.get("/order/getMyOldOrders/"+$scope.order.count+"/"+$scope.order.oldCount+"/"+$scope.order.oldMaxCount).success(function(data){var orderData=data.data,orderArray=orderData.orders,len=orderArray.length;data.status&&len<=orderData.maxCount&&($scope.order.content=orderArray,$scope.order.oldCount=len,$scope.order.oldMaxCount=orderData.maxCount,len==orderData.maxCount&&($scope.order.mostData=!0)),$scope.$broadcast("scroll.infiniteScrollComplete")})}}]).controller("quotationCtrl",["$scope","$ionicPopup","httpService","$state","$stateParams","$ionicHistory","$ionicTabsDelegate",function($scope,$ionicPopup,httpService,$state,$stateParams,$ionicHistory,$ionicTabsDelegate){$ionicTabsDelegate.showBar(!1),$scope.show_error=!1,$scope.quo={btnText:"报价",isFirst:!1},$scope.productQuo={unitPrice:"",totalPrice:""},httpService.get("/order/getByOrderName/"+$stateParams.orderId).success(function(data){$scope.order=data.data}),httpService.get("/order/getSupQuotation/"+$stateParams.orderId).success(function(data){if(data.status){var quotation=data.data;$scope.productQuo={unitPrice:quotation.unitPrice,totalPrice:quotation.sumPrice},$scope.quo.btnText="修改报价"}else $scope.quo.isFirst=!0}),$scope.canlTotalPrice=function(orderNum){$scope.productQuo.unitPrice=parseInt($scope.productQuo.unitPrice)>0?$scope.productQuo.unitPrice:"",$scope.productQuo.totalPrice=$scope.productQuo.unitPrice*orderNum!=0?$scope.productQuo.unitPrice*orderNum:""},$scope.quotation=function(myform){myform.$dirty&&($scope.show_error=!0,myform.$valid&&httpService.post("/order/setQuotation",{unitPrice:$scope.productQuo.unitPrice,sumPrice:$scope.productQuo.totalPrice,orderName:$stateParams.orderId}).success(function(data){data.status&&$ionicPopup.alert({template:"报价完成，返回订单列表",okText:"确认",okType:"button-my-balanced"}).then(function(data){data&&$state.go("supplier.orderList")})}))}}]).controller("orderDetailCtrl",["$scope","httpService","$ionicPopup","$stateParams","$ionicHistory","$ionicTabsDelegate",function($scope,httpService,$ionicPopup,$stateParams,$ionicHistory,$ionicTabsDelegate){$ionicTabsDelegate.showBar(!1),$scope.showDelivery=!1,$scope.delivery=function(){httpService.post("/order/sendGoods",{orderName:$stateParams.orderId}).success(function(data){data.status&&($ionicPopup.alert({template:"已发货",okText:"确认",okType:"button-my-balanced"}),$scope.showDelivery=!1)})},httpService.get("/order/getByOrderName/"+$stateParams.orderId).success(function(data){$scope.order=data.data;var orderState=$scope.order.state;("待支付"==orderState||"未支付"==orderState||"已支付"==orderState)&&($scope.showDelivery=!0)})}]).controller("LogisTrackCtrl",["$scope","httpService","$stateParams","$ionicTabsDelegate",function($scope,httpService,$stateParams,$ionicTabsDelegate){$ionicTabsDelegate.showBar(!1),$scope.logistics={info:""},httpService.get("/order/getLogistics/"+$stateParams.orderId).success(function(data){if(data.status){var dataArray=data.data;$scope.transit=dataArray}}),httpService.get("/order/getByOrderName/"+$stateParams.orderId).success(function(data){data.status&&($scope.order=data.data)}),$scope.addLogisticsInfo=function(info){httpService.post("/order/addLogistics",{orderName:$stateParams.orderId,info:info}).success(function(data){data.status&&$scope.transit.unshift(data.data)}),$scope.logistics.info=""}}]),angular.module("starter.directive",[]).directive("supplierRelease",["$timeout",function($timeout){return{restrict:"E",link:function($scope,$element){}}}]).directive("hideTabs",["$rootScope",function($rootScope){return{restrict:"A",scope:{},link:function(scope,element,attr){scope.$watch(attr.hideTabs,function(value){$rootScope.main.hideTabs=value}),scope.$on("$destroy",function(){$rootScope.main.hideTabs=!1})}}}]).directive("repeat",[function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){if(ctrl){var otherInput=element.inheritedData("$formController")[attrs.repeat],repeatValidator=function(value){var validity=value===otherInput.$viewValue;return ctrl.$setValidity("repeat",validity),validity?value:void 0};ctrl.$parsers.push(repeatValidator),ctrl.$formatters.push(repeatValidator),otherInput.$parsers.push(function(value){return ctrl.$setValidity("repeat",value===ctrl.$viewValue),value})}}}}]).directive("selectImg",["$ionicActionSheet","$cordovaCamera","$ionicPopup",function($ionicActionSheet,$cordovaCamera,$ionicPopup){return{restrict:"A",link:function(scope,element){element.bind("click",function(){var hideSheet=$ionicActionSheet.show({buttons:[{text:'<i class="icon ion-android-camera positive"></i>拍照'},{text:'<i class="icon ion-android-image royal"></i>从图库选择'}],buttonClicked:function(index){if(0==index){var options={quality:50,destinationType:1,sourceType:1,targetHeight:200,targetWidth:200};$cordovaCamera.getPicture(options).then(function(imageURI){scope.userRegisInfo.myCredentials.push(imageURI),hideSheet()},function(err){alert(err)})}else 1==index&&window.imagePicker.getPictures(function(results){hideSheet();for(var i=0;i<results.length;i++)scope.userRegisInfo.myCredentials.push(results[i])},function(error){alert("imagePicker.getPictures:  "+error)},{width:260,height:260,quality:70})}})}),scope.onHoldImg=function(index){var confirmPopup=$ionicPopup.confirm({okText:"确认",okType:"button-balanced",cancelText:"取消",template:"确认要删除这张图片吗？"});confirmPopup.then(function(res){res&&scope.userRegisInfo.myCredentials.splice(index,1)})}}}}]),angular.module("starter.filter",[]).filter("chineseWeek",function(){return function(enWeek,type){var zhWeek1="",zhWeek2="";switch(enWeek){case"Mon":case"Monday":zhWeek1="周一",zhWeek2="星期一";break;case"Tue":case"Tuesday":zhWeek1="周二",zhWeek2="星期二";break;case"Wed":case"Wednesday":zhWeek1="周三",zhWeek2="星期三";break;case"Thu":case"Thursday":zhWeek1="周四",zhWeek2="星期四";break;case"Fri":case"Friday":zhWeek1="周五",zhWeek2="星期五";break;case"Sat":case"Saturday":zhWeek1="周六",zhWeek2="星期六";break;case"Sun":case"Sunday":zhWeek1="周日",zhWeek2="星期天"}return type?zhWeek1:zhWeek2}}),angular.module("starter.service",[]).factory("httpService",["$q","$http","CONFIG","$cookieStore","$ionicBackdrop","$ionicLoading","$ionicPopup","$cordovaInAppBrowser",function($q,$http,CONFIG,$cookieStore,$ionicBackdrop,$ionicLoading,$ionicPopup,$cordovaInAppBrowser){function errorHandle(data,status){if(403===status){var iosPath=data.app_ios_path,androidPath=data.app_andriod_path;$ionicPopup.alert({title:"更新提示",template:"检测到有新版本，为了不影响您继续使用请立即更新！",okText:"立即更新",cancelText:"稍后再说",okType:"button-my-balanced",cancelType:"button-stable"}).then(function(data){data&&(ionic.Platform.isIOS()?(console.log(iosPath),$cordovaInAppBrowser.open(iosPath,"_system").then(function(){console.log("success")})):ionic.Platform.isAndroid()&&(console.log(androidPath),$cordovaInAppBrowser.open(androidPath,"_system").then(function(){console.log("success")})))})}}return{post:function(url,params){$ionicBackdrop.retain(),$ionicLoading.show({template:"<ion-spinner icon='ios' class='spinner spinner-ios '></ion-spinner>",noBackdrop:!0});var token=window.localStorage.token,appVersion=window.localStorage.appVersion,config={headers:{"x-access-token":token,"x-app-version":appVersion}};console.log("--------"),console.info(config),console.log("--------");var host="";return host=CONFIG.serveHost?CONFIG.serveHost:CONFIG.host,$http.post(host+url,params,config).success(function(){$ionicBackdrop.release(),$ionicLoading.hide()}).error(function(data,status){errorHandle(data,status),$ionicBackdrop.release(),$ionicLoading.hide()})},get:function(url,params){$ionicBackdrop.retain(),$ionicLoading.show({template:"<ion-spinner icon='ios' class='spinner spinner-ios '></ion-spinner>",noBackdrop:!0});var token=window.localStorage.token,appVersion=window.localStorage.appVersion,config={headers:{"x-access-token":token,"x-app-version":appVersion},params:params};console.log("--------"),console.info(config),console.log("--------");var host="";return host=CONFIG.serveHost?CONFIG.serveHost:CONFIG.host,$http.get(host+url,config).success(function(){$ionicBackdrop.release(),$ionicLoading.hide()}).error(function(data,status){errorHandle(data,status),$ionicBackdrop.release(),$ionicLoading.hide()})}}}]);